<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Intellexa - Company Intelligence</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: Inter, -apple-system, sans-serif;
  background: #0a0a0a;
  color: #e0e0e0;
  line-height: 1.6;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
}

/* Header */
.header {
  background: #1a1a1a;
  border-bottom: 1px solid #333;
  padding: 20px 0;
  position: sticky;
  top: 0;
  z-index: 100;
}

.header-content {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.logo {
  font-size: 24px;
  font-weight: 700;
  color: #fff;
}

.search-box {
  flex: 1;
  max-width: 600px;
  margin: 0 40px;
  position: relative;
}

.search-input {
  width: 100%;
  padding: 12px 20px;
  background: #2a2a2a;
  border: 1px solid #444;
  border-radius: 8px;
  color: #fff;
  font-size: 15px;
}

.search-input:focus {
  outline: none;
  border-color: #666;
  background: #333;
}

.search-results {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: #2a2a2a;
  border: 1px solid #444;
  border-top: none;
  max-height: 400px;
  overflow-y: auto;
  display: none;
  margin-top: 1px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
}

.search-results.show { display: block; }

.search-item {
  padding: 15px 20px;
  border-bottom: 1px solid #333;
  cursor: pointer;
  transition: background 0.2s;
}

.search-item:hover {
  background: #333;
}

.search-item-name {
  font-weight: 600;
  margin-bottom: 4px;
}

.search-item-meta {
  font-size: 13px;
  color: #999;
}

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin: 30px 0;
}

.stat-card {
  background: #1a1a1a;
  padding: 24px;
  border-radius: 12px;
  border: 1px solid #333;
  cursor: pointer;
  transition: all 0.2s;
}

.stat-card:hover {
  border-color: #555;
  transform: translateY(-2px);
}

.stat-label {
  font-size: 13px;
  color: #999;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 10px;
}

.stat-value {
  font-size: 36px;
  font-weight: 300;
  margin-bottom: 8px;
}

.stat-change {
  font-size: 13px;
  color: #4caf50;
}

.stat-change.negative {
  color: #f44336;
}

/* Company View */
.company-view {
  display: none;
}

.company-view.active {
  display: block;
}

.back-btn {
  padding: 10px 20px;
  background: #2a2a2a;
  border: 1px solid #444;
  border-radius: 8px;
  color: #fff;
  cursor: pointer;
  font-size: 14px;
  margin-bottom: 20px;
  display: inline-block;
}

.back-btn:hover {
  background: #333;
}

.company-header {
  background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
  padding: 40px;
  border-radius: 12px;
  margin-bottom: 30px;
}

.company-name {
  font-size: 32px;
  font-weight: 700;
  margin-bottom: 15px;
}

.company-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.company-stat {
  display: flex;
  flex-direction: column;
}

.company-stat-label {
  font-size: 12px;
  opacity: 0.8;
  margin-bottom: 4px;
}

.company-stat-value {
  font-size: 18px;
  font-weight: 600;
}

.company-description {
  background: #1a1a1a;
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  border: 1px solid #333;
}

/* Score Card */
.score-card {
  background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
  padding: 30px;
  border-radius: 12px;
  margin-bottom: 30px;
  border: 2px solid #333;
  text-align: center;
}

.score-badge {
  display: inline-block;
  padding: 8px 20px;
  border-radius: 20px;
  font-weight: 600;
  font-size: 14px;
  margin-bottom: 20px;
}

.score-badge.GREEN {
  background: rgba(76, 175, 80, 0.2);
  color: #4caf50;
  border: 1px solid #4caf50;
}

.score-badge.YELLOW {
  background: rgba(255, 193, 7, 0.2);
  color: #ffc107;
  border: 1px solid #ffc107;
}

.score-badge.RED {
  background: rgba(244, 67, 54, 0.2);
  color: #f44336;
  border: 1px solid #f44336;
}

.score-number {
  font-size: 72px;
  font-weight: 300;
  margin: 20px 0;
}

.score-recommendation {
  font-size: 16px;
  color: #ccc;
  margin-bottom: 30px;
}

.score-factors {
  text-align: left;
  background: #1a1a1a;
  padding: 20px;
  border-radius: 8px;
}

.factor-title {
  font-weight: 600;
  margin-bottom: 15px;
  color: #fff;
}

.factor {
  padding: 10px;
  margin: 8px 0;
  background: #2a2a2a;
  border-radius: 6px;
  border-left: 3px solid #4caf50;
}

/* Tabs */
.tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  border-bottom: 1px solid #333;
  padding-bottom: 0;
}

.tab {
  padding: 12px 24px;
  background: transparent;
  border: none;
  color: #999;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
}

.tab:hover {
  color: #fff;
}

.tab.active {
  color: #fff;
  border-bottom-color: #4caf50;
}

.tab-content {
  display: none;
  animation: fadeIn 0.3s;
}

.tab-content.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* Analysis Grid */
.analysis-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 30px;
}

.analysis-panel {
  background: #1a1a1a;
  padding: 24px;
  border-radius: 12px;
  border: 1px solid #333;
}

.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 1px solid #333;
}

.panel-title {
  font-size: 18px;
  font-weight: 600;
}

.panel-badge {
  padding: 4px 12px;
  background: #2a2a2a;
  border-radius: 12px;
  font-size: 12px;
  color: #999;
}

.analysis-section {
  margin: 20px 0;
}

.section-title {
  font-size: 13px;
  font-weight: 600;
  color: #4caf50;
  margin-bottom: 12px;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.analysis-list {
  list-style: none;
}

.analysis-list li {
  padding: 8px 0;
  padding-left: 20px;
  position: relative;
  color: #ccc;
  line-height: 1.6;
}

.analysis-list li:before {
  content: "‚Ä¢";
  position: absolute;
  left: 0;
  color: #4caf50;
}

/* Data Section */
.data-section {
  background: #1a1a1a;
  padding: 24px;
  border-radius: 12px;
  border: 1px solid #333;
  margin-bottom: 20px;
}

.data-row {
  display: flex;
  justify-content: space-between;
  padding: 12px 0;
  border-bottom: 1px solid #2a2a2a;
}

.data-row:last-child {
  border-bottom: none;
}

.data-label {
  color: #999;
  font-size: 14px;
}

.data-value {
  color: #fff;
  font-weight: 500;
  text-align: right;
}

/* Loading */
.loading {
  text-align: center;
  padding: 40px;
  color: #999;
}

.spinner {
  width: 40px;
  height: 40px;
  margin: 0 auto 20px;
  border: 3px solid #333;
  border-top-color: #4caf50;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.error {
  background: rgba(244, 67, 54, 0.1);
  border: 1px solid #f44336;
  padding: 20px;
  border-radius: 8px;
  margin: 20px 0;
  color: #f44336;
}

/* Responsive */
@media (max-width: 768px) {
  .analysis-grid {
    grid-template-columns: 1fr;
  }
  
  .header-content {
    flex-direction: column;
    gap: 15px;
  }
  
  .search-box {
    margin: 0;
    width: 100%;
  }
}
</style>
</head>
<body>

<div class="header">
  <div class="header-content">
    <div class="logo">üéØ Intellexa</div>
    <div class="search-box">
      <input 
        type="text" 
        class="search-input" 
        id="searchInput"
        placeholder="Search companies..."
        autocomplete="off"
      >
      <div class="search-results" id="searchResults"></div>
    </div>
    <div style="color: #999; font-size: 14px;">Company Intelligence</div>
  </div>
</div>

<div class="container">
  <!-- Dashboard View -->
  <div id="dashboardView">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Companies</div>
        <div class="stat-value" id="totalCompanies">-</div>
        <div class="stat-change" id="totalChange">Loading...</div>
      </div>
      <div class="stat-card" onclick="filterCompanies('GREEN')">
        <div class="stat-label">High-Value Prospects</div>
        <div class="stat-value" id="greenCount">-</div>
        <div class="stat-change">GREEN (75-100)</div>
      </div>
      <div class="stat-card" onclick="filterCompanies('YELLOW')">
        <div class="stat-label">Medium Prospects</div>
        <div class="stat-value" id="yellowCount">-</div>
        <div class="stat-change">YELLOW (50-74)</div>
      </div>
      <div class="stat-card" onclick="filterCompanies('RED')">
        <div class="stat-label">Low Priority</div>
        <div class="stat-value" id="redCount">-</div>
        <div class="stat-change">RED (0-49)</div>
      </div>
    </div>

    <div class="data-section">
      <div class="section-title">Top Countries</div>
      <div id="countriesData">
        <div class="loading">
          <div class="spinner"></div>
          Loading statistics...
        </div>
      </div>
    </div>

    <div class="data-section">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div class="section-title">All Companies</div>
        <input type="text" id="companyTableSearch" placeholder="Filter companies..." style="padding: 8px 15px; background: #2a2a2a; border: 1px solid #444; border-radius: 6px; color: #fff; width: 300px;">
      </div>
      <div id="companiesTable">
        <div class="loading">
          <div class="spinner"></div>
          Loading companies...
        </div>
      </div>
    </div>
  </div>

  <!-- Company View -->
  <div id="companyView" class="company-view">
    <button class="back-btn" onclick="showDashboard()">‚Üê Back to Dashboard</button>
    
    <div id="companyData">
      <div class="loading">
        <div class="spinner"></div>
        Loading company data...
      </div>
    </div>
  </div>
</div>

<script>
const API_BASE = 'http://localhost:8000/api/v1';
let searchTimeout = null;
let analysisReadyByCompanyId = {};

let currentCompanyLoadSeq = 0;
let activeCompanyId = null;
let activeCompanyData = null;
let activeControllers = {
  company: null,
  analysis: null,
  analysisGenerate: null,
  events: null,
  monitorNews: null,
};

function abortActiveRequests() {
  Object.values(activeControllers).forEach(c => {
    try { c?.abort?.(); } catch (_) {}
  });
  activeControllers = { company: null, analysis: null, analysisGenerate: null, events: null, monitorNews: null };
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  loadDashboard();
  setupSearch();
});

// Dashboard
async function loadDashboard() {
  try {
    // Get counts
    const countRes = await fetch(`${API_BASE}/companies/stats/count`);
    const count = await countRes.json();
    document.getElementById('totalCompanies').textContent = count.count.toLocaleString();
    
    // Recent companies
    const recentRes = await fetch(`${API_BASE}/companies/recent?days=1&limit=100`);
    const recent = await recentRes.json();
    document.getElementById('totalChange').textContent = `+${recent.length} today`;
    
    // Score counts
    loadScoreCounts();
    
    // Countries
    loadCountries();
    
    // Companies table
    loadCompaniesTable();
  } catch (err) {
    console.error('Dashboard load error:', err);
    document.getElementById('totalCompanies').textContent = 'Error';
    document.getElementById('totalChange').textContent = 'Check API';
  }
}

async function loadScoreCounts() {
  try {
    const [green, yellow, red] = await Promise.all([
      fetch(`${API_BASE}/analysis/filter/by-label/GREEN?limit=1000`).then(r => r.json()),
      fetch(`${API_BASE}/analysis/filter/by-label/YELLOW?limit=1000`).then(r => r.json()),
      fetch(`${API_BASE}/analysis/filter/by-label/RED?limit=1000`).then(r => r.json())
    ]);
    
    document.getElementById('greenCount').textContent = green.length.toLocaleString();
    document.getElementById('yellowCount').textContent = yellow.length.toLocaleString();
    document.getElementById('redCount').textContent = red.length.toLocaleString();
  } catch (err) {
    console.error('Score count error:', err);
  }
}

async function loadCountries() {
  try {
    const res = await fetch(`${API_BASE}/companies?limit=500`);
    const companies = await res.json();
    
    const counts = {};
    companies.forEach(c => {
      const country = c.geography?.hq?.country || 'Unknown';
      counts[country] = (counts[country] || 0) + 1;
    });
    
    const sorted = Object.entries(counts)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 10);
    
    const html = sorted.map(([country, count]) => `
      <div class="data-row">
        <div class="data-label">${getFlag(country)} ${country}</div>
        <div class="data-value">${count.toLocaleString()}</div>
      </div>
    `).join('');
    
    document.getElementById('countriesData').innerHTML = html;
  } catch (err) {
    document.getElementById('countriesData').innerHTML = '<div class="error">Error loading countries</div>';
  }
}

function getFlag(country) {
  const flags = {
    'United States': 'üá∫üá∏',
    'India': 'üáÆüá≥',
    'United Kingdom': 'üá¨üáß',
    'Canada': 'üá®üá¶',
    'Singapore': 'üá∏üá¨',
    'Germany': 'üá©üá™',
    'France': 'üá´üá∑'
  };
  return flags[country] || 'üåç';
}

// Search
function setupSearch() {
  const input = document.getElementById('searchInput');
  input.addEventListener('input', handleSearch);
  
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.search-box')) {
      document.getElementById('searchResults').classList.remove('show');
    }
  });
}

async function handleSearch(e) {
  const query = e.target.value.trim();
  const results = document.getElementById('searchResults');
  
  if (query.length < 2) {
    results.classList.remove('show');
    return;
  }
  
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(async () => {
    try {
      // First try regular database search
      results.innerHTML = '<div class="search-item"><div style="padding: 10px; color: #999;">üîç Searching database...</div></div>';
      results.classList.add('show');
      
      const res = await fetch(`${API_BASE}/companies/search/?q=${encodeURIComponent(query)}&limit=10`);
      const companies = await res.json();
      
      if (companies.length === 0) {
        // Not found in database - offer to scrape
        results.innerHTML = `
          <div class="search-item" style="border-left: 3px solid #ffc107;">
            <div class="search-item-name">‚ùå "${query}" not found in database</div>
            <div class="search-item-meta" style="margin: 10px 0; color: #999;">
              This company is not in our database yet
            </div>
            <button 
              onclick="scrapeCompany('${query}')" 
              style="background: linear-gradient(135deg, #4caf50, #45a049); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%;"
            >
              üåê Scrape from Internet
            </button>
          </div>
        `;
      } else {
        results.innerHTML = companies.map(c => `
          <div class="search-item" onclick="loadCompany('${c._id}')">
            <div class="search-item-name">‚úÖ ${c.company_name}</div>
            <div class="search-item-meta">
              ${c.industries?.join(', ') || 'N/A'} ‚Ä¢ 
              ${c.geography?.hq?.country || 'Unknown'}
            </div>
          </div>
        `).join('');
      }
      
      results.classList.add('show');
    } catch (err) {
      console.error('Search error:', err);
      results.innerHTML = '<div class="search-item" style="color: #f44336;">‚ùå Search error - check console</div>';
    }
  }, 300);
}

async function scrapeCompany(companyName) {
  const results = document.getElementById('searchResults');

  const renderProgress = (progress) => {
    const pct = Math.max(0, Math.min(100, progress?.progress_percentage ?? 0));
    const step = progress?.current_step || 'Starting...';
    const status = progress?.status || 'pending';
    const errors = (progress?.errors || []).slice(-2);

    results.innerHTML = `
      <div class="search-item" style="cursor: default; border-left: 3px solid #4caf50;">
        <div class="search-item-name">üåê Gathering "${companyName}"</div>
        <div class="search-item-meta" style="margin-top: 6px; color: #ccc;">
          <div><strong>${pct}%</strong> ‚Ä¢ ${status}</div>
          <div style="margin-top: 6px; color: #999;">${step}</div>
          <div style="margin-top: 8px; height: 6px; background: #333; border-radius: 3px; overflow: hidden;">
            <div style="width:${pct}%; height: 100%; background: #4caf50;"></div>
          </div>
          <div style="margin-top: 8px; font-size: 12px; color: #777;">
            DB check ‚Üí Perplexity ‚Üí Verification ‚Üí Web scrape ‚Üí Mistral normalize ‚Üí Save
          </div>
          ${errors.length ? `<div style="margin-top: 8px; font-size: 12px; color: #ffc107;">‚ö†Ô∏è ${errors.map(e => String(e)).join(' ‚Ä¢ ')}</div>` : ''}
        </div>
      </div>
    `;
  };

  // Initial UI
  renderProgress({ progress_percentage: 0, current_step: 'Starting request...', status: 'pending', errors: [] });

  // Start the gather request (runs the full pipeline + saves before returning)
  const gatherPromise = fetch(`${API_BASE}/scraping/gather?skip_ai_search=true`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ company_name: companyName, force_rescrape: false })
  });

  // Poll progress while gather is running
  let pollTimer = setInterval(async () => {
    try {
      const pRes = await fetch(`${API_BASE}/scraping/progress/${encodeURIComponent(companyName)}`);
      if (!pRes.ok) return;
      const progress = await pRes.json();
      renderProgress(progress);
    } catch (_) {
      // ignore polling errors
    }
  }, 1000);

  try {
    const res = await gatherPromise;
    clearInterval(pollTimer);

    if (!res.ok) {
      let detail = `HTTP ${res.status}`;
      try {
        const body = await res.json();
        detail = body?.detail || JSON.stringify(body);
      } catch (_) {
        // ignore
      }
      throw new Error(detail);
    }

    const result = await res.json();

    if (result?.status === 'success' || result?.status === 'partial') {
      if (result.company_id) {
        results.innerHTML = `
          <div class="search-item" style="border-left: 3px solid #4caf50;" onclick="loadCompany('${result.company_id}')">
            <div class="search-item-name">‚úÖ ${result.company_name} (Updated)</div>
            <div class="search-item-meta">
              Completeness: ${(result.data_completeness * 100).toFixed(0)}% ‚Ä¢ 
              Found: ${result.found_fields}/${result.total_fields}
            </div>
            <div style="margin-top: 8px; padding: 8px; background: rgba(76, 175, 80, 0.1); border-radius: 4px; font-size: 12px; color: #4caf50;">
              üéâ Data formatted by local Mistral and saved. Click to view.
            </div>
          </div>
        `;
      } else {
        results.innerHTML = `
          <div class="search-item" style="border-left: 3px solid #ffc107; cursor: default;">
            <div class="search-item-name">‚ö†Ô∏è ${result.company_name} gathered, but not saved</div>
            <div class="search-item-meta" style="color: #999;">Check backend logs for schema/validation issues.</div>
          </div>
        `;
      }
    } else {
      results.innerHTML = `
        <div class="search-item" style="border-left: 3px solid #f44336; cursor: default;">
          <div class="search-item-name">‚ùå Data gathering failed</div>
          <div class="search-item-meta" style="color: #f44336;">
            ${(result?.errors || []).slice(0, 3).map(e => String(e)).join('<br>') || 'Unknown error'}
          </div>
        </div>
      `;
    }
  } catch (err) {
    clearInterval(pollTimer);
    console.error('Scraping error:', err);
    results.innerHTML = `
      <div class="search-item" style="border-left: 3px solid #f44336; cursor: default;">
        <div class="search-item-name">‚ùå Error</div>
        <div class="search-item-meta" style="color: #f44336;">
          ${err?.message || 'Unknown error during scraping'}
        </div>
      </div>
    `;
  }
}

// Company View
async function loadCompany(id) {
  // Cancel any in-flight fetches from previous selections
  abortActiveRequests();
  const loadSeq = ++currentCompanyLoadSeq;
  activeCompanyId = id;
  activeCompanyData = null;

  document.getElementById('searchResults').classList.remove('show');
  document.getElementById('searchInput').value = '';
  document.getElementById('dashboardView').style.display = 'none';
  document.getElementById('companyView').classList.add('active');
  
  const container = document.getElementById('companyData');
  container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading company...</div>';
  
  try {
    // Load company
    activeControllers.company = new AbortController();
    const compRes = await fetch(`${API_BASE}/companies/${id}`, { signal: activeControllers.company.signal });
    const company = await compRes.json();
    activeCompanyData = company;

    // If user navigated away mid-fetch, ignore
    if (loadSeq !== currentCompanyLoadSeq || activeCompanyId !== id) return;
    
    // Try to get existing analysis
    let analysis = null;
    try {
      console.log('[Analysis] Fetching cached analysis for company:', id);
      activeControllers.analysis = new AbortController();
      const anaRes = await fetch(`${API_BASE}/analysis/company/${id}/latest`, { signal: activeControllers.analysis.signal });
      console.log('[Analysis] Cache response status:', anaRes.status, anaRes.ok);
      
      if (anaRes.ok) {
        analysis = await anaRes.json();
        console.log('[Analysis] ‚úÖ Found cached analysis:', analysis);
        analysisReadyByCompanyId[id] = true;
      } else {
        console.log('[Analysis] ‚ö†Ô∏è No cached analysis found (404)');
      }
    } catch (err) {
      if (err?.name !== 'AbortError') {
        console.error('[Analysis] ‚ùå Error fetching cached analysis:', err);
      }
    }

    if (loadSeq !== currentCompanyLoadSeq || activeCompanyId !== id) return;
    
    if (analysis) {
      console.log('[Analysis] ‚ö° Using cached analysis (instant)');
    }

    if (loadSeq !== currentCompanyLoadSeq || activeCompanyId !== id) return;
    
    displayCompany(company, analysis);
    
    // Load events for this company
    loadEvents(id, loadSeq);
  } catch (err) {
    if (err?.name === 'AbortError') return;
    container.innerHTML = `<div class="error">Error: ${err.message}</div>`;
  }
}

async function loadEvents(companyId, loadSeq = currentCompanyLoadSeq) {
  const container = document.getElementById('eventsTab');
  
  if (!container) {
    console.error('Events tab container not found');
    return;
  }
  
  try {
    container.innerHTML = '<div class="loading"><div class="spinner"></div>Fetching news & events...</div>';
    
    // Fetch events for this company
    console.log('Fetching events for company:', companyId);
    activeControllers.events = new AbortController();
    const res = await fetch(`${API_BASE}/events/company/${companyId}?limit=50`, { signal: activeControllers.events.signal });

    if (loadSeq !== currentCompanyLoadSeq || activeCompanyId !== companyId) return;
    
    console.log('Events response status:', res.status);
    
    if (!res.ok) {
      const errorText = await res.text();
      console.error('Events fetch failed:', res.status, errorText);
      
      // Try fetching all events and filter client-side as fallback
      console.log('Trying fallback: fetch all events');
      activeControllers.events = new AbortController();
      const allRes = await fetch(`${API_BASE}/events/?limit=200`, { signal: activeControllers.events.signal });
      if (allRes.ok) {
        const allEvents = await allRes.json();
        // Filter events for this company
        const companyEvents = allEvents.filter(e => e.company_id === companyId);
        console.log('Filtered events:', companyEvents.length);
        if (loadSeq !== currentCompanyLoadSeq || activeCompanyId !== companyId) return;
        if (companyEvents.length === 0) {
          container.innerHTML = `
            <div class="data-section">
              <div class="no-data" style="display:flex; align-items:center; justify-content:space-between; gap: 12px;">
                <div>No events found yet. Click Refresh News to fetch.</div>
                <button id="refreshNewsBtn" style="background:#2a2a2a; border:1px solid #444; color:#fff; padding:10px 14px; border-radius:8px; cursor:pointer;">Refresh News</button>
              </div>
            </div>
          `;
          const refreshBtn = document.getElementById('refreshNewsBtn');
          if (refreshBtn) {
            refreshBtn.onclick = () => refreshNews(companyId, loadSeq);
          }
        } else {
          container.innerHTML = displayEvents(companyEvents);
        }
        return;
      }
      
      container.innerHTML = displayEvents([]);
      return;
    }
    
    const events = await res.json();
    console.log('Events received:', events.length);
    if (loadSeq !== currentCompanyLoadSeq || activeCompanyId !== companyId) return;

    if (Array.isArray(events) && events.length === 0) {
      container.innerHTML = `
        <div class="data-section">
          <div class="no-data" style="display:flex; align-items:center; justify-content:space-between; gap: 12px;">
            <div>No events found yet. Click Refresh News to fetch.</div>
            <button id="refreshNewsBtn" style="background:#2a2a2a; border:1px solid #444; color:#fff; padding:10px 14px; border-radius:8px; cursor:pointer;">Refresh News</button>
          </div>
        </div>
      `;
      const refreshBtn = document.getElementById('refreshNewsBtn');
      if (refreshBtn) {
        refreshBtn.onclick = () => refreshNews(companyId, loadSeq);
      }
    } else {
      container.innerHTML = displayEvents(events);
    }
  } catch (err) {
    if (err?.name === 'AbortError') return;
    console.error('Events load error:', err);
    container.innerHTML = `
      <div class="data-section">
        <div class="error">
          Failed to load events: ${err.message}<br>
          <small>Check browser console for details</small>
        </div>
      </div>
    `;
  }
}

async function refreshNews(companyId, loadSeq = currentCompanyLoadSeq) {
  const container = document.getElementById('eventsTab');
  if (!container) return;
  if (activeCompanyId !== companyId) return;

  container.innerHTML = '<div class="loading"><div class="spinner"></div>Refreshing news‚Ä¶</div>';
  try {
    activeControllers.monitorNews = new AbortController();
    const monitorRes = await fetch(`${API_BASE}/events/monitor/${companyId}`, {
      method: 'POST',
      signal: activeControllers.monitorNews.signal,
    });

    if (loadSeq !== currentCompanyLoadSeq || activeCompanyId !== companyId) return;

    if (!monitorRes.ok) {
      let detail = `HTTP ${monitorRes.status}`;
      try {
        const body = await monitorRes.json();
        detail = body?.detail || JSON.stringify(body);
      } catch (_) {}
      container.innerHTML = `<div class="data-section"><div class="error">‚ùå Failed to refresh news: ${detail}</div></div>`;
      return;
    }

    await loadEvents(companyId, loadSeq);
  } catch (err) {
    if (err?.name === 'AbortError') return;
    container.innerHTML = `<div class="data-section"><div class="error">‚ùå Failed to refresh news: ${err.message}</div></div>`;
  }
}

function displayCompany(company, analysis) {
  const html = `
    <div class="company-header">
      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
        <div class="company-name">${company.company_name}</div>
        <button onclick="forceRescrape('${company._id}', '${company.company_name}')" style="background: linear-gradient(135deg, #ff9800, #f57c00); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">üîÑ Force Rescrape</button>
      </div>
      <div class="company-stats">
        <div class="company-stat">
          <div class="company-stat-label">Industry</div>
          <div class="company-stat-value">${company.industries?.join(', ') || 'N/A'}</div>
        </div>
        <div class="company-stat">
          <div class="company-stat-label">Employees</div>
          <div class="company-stat-value">${company.company_size?.employee_count?.toLocaleString() || 'Unknown'}</div>
        </div>
        <div class="company-stat">
          <div class="company-stat-label">Revenue</div>
          <div class="company-stat-value">${company.revenue?.value ? '$' + (company.revenue.value / 1e9).toFixed(2) + 'B' : 'Unknown'}</div>
        </div>
        <div class="company-stat">
          <div class="company-stat-label">Location</div>
          <div class="company-stat-value">${company.geography?.hq?.country || 'Unknown'}</div>
        </div>
      </div>
    </div>
    
    ${company.description ? `<div class="company-description">${company.description}</div>` : ''}
    
    ${displayScore(analysis)}
    
    <div class="tabs">
      <button class="tab active" onclick="switchTab(0)">üß† AI Analysis</button>
      <button class="tab" onclick="switchTab(1)">üì∞ News & Events</button>
      <button class="tab" onclick="switchTab(2)">üéØ Competitors</button>
      <button class="tab" onclick="switchTab(3)">‚ö†Ô∏è Risks</button>
      <button class="tab" onclick="switchTab(4)">üìä Raw Data</button>
    </div>
    
    <div class="tab-content active">${displayAnalysis(company, analysis)}</div>
    <div class="tab-content"><div id="eventsTab">Loading events...</div></div>
    <div class="tab-content">${displayCompetitors(analysis)}</div>
    <div class="tab-content">${displayRisks(analysis)}</div>
    <div class="tab-content">${displayRawData(company)}</div>
  `;
  
  document.getElementById('companyData').innerHTML = html;
}

function displayScore(analysis) {
  if (!analysis || !analysis.client_score) {
    return `
      <div class="score-card">
        <div class="score-badge GRAY">PENDING</div>
        <div class="score-number">--/100</div>
        <div class="score-recommendation">‚è≥ No analysis yet. Use ‚ÄúGenerate Analysis‚Äù below.</div>
      </div>
    `;
  }
  
  const score = analysis.client_score;
  return `
    <div class="score-card">
      <div class="score-badge ${score.label}">${score.label} SCORE</div>
      <div class="score-number">${score.value}/100</div>
      <div class="score-recommendation">${score.recommendation}</div>
      <div class="score-factors">
        <div class="factor-title">Key Factors:</div>
        ${score.factors.map(f => `<div class="factor">${f}</div>`).join('')}
      </div>
    </div>
  `;
}

function displayAnalysis(company, analysis) {
  return `
    <div class="analysis-grid">
      <div class="analysis-panel">
        <div class="panel-header">
          <div class="panel-title">üß† Mistral AI Analysis</div>
          <div class="panel-badge">Ollama</div>
        </div>
        ${displayMistral(company._id, analysis)}
      </div>
      
      <div class="analysis-panel">
        <div class="panel-header">
          <div class="panel-title">üìä Source Data</div>
          <div class="panel-badge">Scraping</div>
        </div>
        ${displaySourceData(company)}
      </div>
    </div>
  `;
}

function displayMistral(companyId, analysis) {
  if (!analysis) {
    return `
      <div style="color: #999; padding: 20px;">
        <div style="margin-bottom: 12px;">No analysis generated yet.</div>
        <button onclick="generateAnalysis('${companyId}')" style="background:#2a2a2a; border:1px solid #444; color:#fff; padding:10px 14px; border-radius:8px; cursor:pointer;">
          Generate Analysis
        </button>
      </div>
    `;
  }
  
  let html = '';
  
  if (analysis.swot_summary) {
    const swot = analysis.swot_summary;
    if (swot.strengths?.length) {
      html += `
        <div class="analysis-section">
          <div class="section-title">Strengths</div>
          <ul class="analysis-list">
            ${swot.strengths.slice(0, 3).map(s => `<li>${s}</li>`).join('')}
          </ul>
        </div>
      `;
    }
    if (swot.opportunities?.length) {
      html += `
        <div class="analysis-section">
          <div class="section-title">Opportunities</div>
          <ul class="analysis-list">
            ${swot.opportunities.slice(0, 3).map(o => `<li>${o}</li>`).join('')}
          </ul>
        </div>
      `;
    }
  }
  
  if (analysis.market_insights) {
    html += `
      <div class="analysis-section">
        <div class="section-title">Market Position</div>
        <ul class="analysis-list">
          <li>Position: ${analysis.market_insights.market_position || 'N/A'}</li>
          <li>Growth: ${analysis.market_insights.growth_potential || 'N/A'}</li>
        </ul>
      </div>
    `;
  }
  
  return html || '<div style="color: #999;">No AI analysis available</div>';
}

async function generateAnalysis(companyId, loadSeq = currentCompanyLoadSeq) {
  if (!companyId || activeCompanyId !== companyId) return;
  const container = document.getElementById('companyData');
  if (!container) return;

  // Cancel any prior analysis generation request
  try { activeControllers.analysisGenerate?.abort?.(); } catch (_) {}

  container.innerHTML = `
    <div class="loading">
      <div class="spinner"></div>
      <div style="margin-top: 10px;">Generating AI analysis (Mistral)‚Ä¶</div>
      <div style="font-size: 13px; color: #999; margin-top: 6px;">This can take a few minutes.</div>
      <button id="cancelAnalysisBtn" style="margin-top: 14px; background: #2a2a2a; border: 1px solid #444; color: #fff; padding: 10px 14px; border-radius: 8px; cursor: pointer;">
        ‚úã Cancel
      </button>
    </div>
  `;

  const cancelBtn = document.getElementById('cancelAnalysisBtn');
  if (cancelBtn) {
    cancelBtn.onclick = () => {
      try { activeControllers.analysisGenerate?.abort?.(); } catch (_) {}
      // Re-render current company view without analysis
      if (activeCompanyData && activeCompanyId === companyId) {
        displayCompany(activeCompanyData, null);
        loadEvents(companyId, loadSeq);
      } else {
        container.innerHTML = '<div class="data-section"><div style="color:#ffc107;">Analysis generation cancelled.</div></div>';
      }
    };
  }

  try {
    activeControllers.analysisGenerate = new AbortController();
    const genRes = await fetch(`${API_BASE}/analysis/generate/${companyId}`, {
      method: 'POST',
      signal: activeControllers.analysisGenerate.signal,
    });

    if (loadSeq !== currentCompanyLoadSeq || activeCompanyId !== companyId) return;

    if (!genRes.ok) {
      let detail = `HTTP ${genRes.status}`;
      try {
        const body = await genRes.json();
        detail = body?.detail || JSON.stringify(body);
      } catch (_) {}
      container.innerHTML = `<div class="data-section"><div class="error">‚ùå Failed to generate analysis: ${detail}</div></div>`;
      return;
    }

    const analysis = await genRes.json();
    analysisReadyByCompanyId[companyId] = true;
    if (activeCompanyData && activeCompanyId === companyId) {
      displayCompany(activeCompanyData, analysis);
      loadEvents(companyId, loadSeq);
    }
  } catch (err) {
    if (err?.name === 'AbortError') return;
    container.innerHTML = `<div class="data-section"><div class="error">‚ùå Failed to generate analysis: ${err.message}</div></div>`;
  }
}

function displaySourceData(company) {
  let html = '';
  
  if (company.offerings?.products?.length) {
    html += `
      <div class="analysis-section">
        <div class="section-title">Products</div>
        <ul class="analysis-list">
          ${company.offerings.products.slice(0, 5).map(p => `<li>${p}</li>`).join('')}
        </ul>
      </div>
    `;
  }
  
  if (company.tech_stack?.length) {
    html += `
      <div class="analysis-section">
        <div class="section-title">Technology</div>
        <ul class="analysis-list">
          ${company.tech_stack.slice(0, 5).map(t => `<li>${t}</li>`).join('')}
        </ul>
      </div>
    `;
  }
  
  if (company.online_presence) {
    html += `
      <div class="analysis-section">
        <div class="section-title">Links</div>
        <ul class="analysis-list">
          ${company.online_presence.website ? `<li><a href="${company.online_presence.website}" target="_blank" style="color: #4caf50">Website</a></li>` : ''}
          ${company.online_presence.linkedin_url ? `<li><a href="${company.online_presence.linkedin_url}" target="_blank" style="color: #4caf50">LinkedIn</a></li>` : ''}
        </ul>
      </div>
    `;
  }
  
  return html || '<div style="color: #999;">No additional data</div>';
}

function displayEvents(events) {
  if (!events || events.length === 0) {
    return `
      <div class="data-section">
        <div style="text-align: center; padding: 40px; color: #999;">
          üì∞ No news or events found<br>
          <small style="font-size: 12px; margin-top: 10px; display: block;">Events are detected from NewsAPI when available</small>
        </div>
      </div>
    `;
  }
  
  const eventTypeColors = {
    'news': '#2196F3',
    'product_launch': '#4caf50',
    'funding': '#ff9800',
    'leadership': '#9c27b0',
    'executive_change': '#9c27b0',
    'legal': '#f44336',
    'legal_issue': '#f44336',
    'partnership': '#00bcd4',
    'expansion': '#00bcd4',
    'other': '#666'
  };
  
  const eventTypeIcons = {
    'news': 'üì∞',
    'product_launch': 'üöÄ',
    'funding': 'üí∞',
    'leadership': 'üëî',
    'executive_change': 'üëî',
    'legal': '‚öñÔ∏è',
    'legal_issue': '‚öñÔ∏è',
    'partnership': 'ü§ù',
    'expansion': 'üåç',
    'other': 'üìå'
  };
  
  return `
    <div class="data-section">
      <div style="margin-bottom: 20px; color: #999; font-size: 13px;">
        üìä ${events.length} event${events.length > 1 ? 's' : ''} found
      </div>
      ${events.map(event => {
        const color = eventTypeColors[event.event_type] || '#666';
        const icon = eventTypeIcons[event.event_type] || 'üìå';
        
        // Handle different date formats
        let date = 'Unknown date';
        if (event.event_date) {
          try {
            date = new Date(event.event_date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
          } catch (e) {
            date = event.event_date;
          }
        }
        
        // Get URL from either url or source_url field
        const eventUrl = event.url || event.source_url;
        
        return `
          <div style="background: #2a2a2a; padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 3px solid ${color};">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
              <div>
                <span style="background: ${color}22; color: ${color}; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase;">
                  ${icon} ${event.event_type ? event.event_type.replace('_', ' ') : 'news'}
                </span>
              </div>
              <div style="color: #999; font-size: 12px;">${date}</div>
            </div>
            <div style="font-weight: 600; margin-bottom: 8px; font-size: 15px;">${event.title || 'No title'}</div>
            <div style="color: #ccc; font-size: 14px; line-height: 1.6; margin-bottom: 12px;">${event.description || event.summary || 'No description available'}</div>
            ${eventUrl ? `<a href="${eventUrl}" target="_blank" style="color: #4caf50; font-size: 13px; text-decoration: none;">üîó Read more ‚Üí</a>` : ''}
            ${event.impact_score ? `<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333; color: #999; font-size: 12px;">Impact: <span style="color: ${event.impact_score > 70 ? '#f44336' : event.impact_score > 40 ? '#ffc107' : '#4caf50'};">${event.impact_score}/100</span></div>` : ''}
          </div>
        `;
      }).join('')}
    </div>
  `;
}

function displayCompetitors(analysis) {
  if (!analysis || !analysis.competitors) {
    return '<div class="data-section"><div style="color: #999;">‚è≥ Competitor analysis pending...</div></div>';
  }
  if (!analysis.competitors?.length) {
    return '<div class="data-section"><div style="color: #999;">No competitors identified</div></div>';
  }
  
  return `
    <div class="data-section">
      ${analysis.competitors.map((c, i) => `
        <div class="data-row">
          <div class="data-label">${i + 1}. ${c.company_name}</div>
          <div class="data-value">
            <span style="color: ${c.threat_level === 'High' ? '#f44336' : c.threat_level === 'Medium' ? '#ffc107' : '#4caf50'}">
              ${c.threat_level || 'Medium'}
            </span>
            <span style="margin-left: 10px; color: #999;">
              ${(c.similarity_score * 100).toFixed(0)}% overlap
            </span>
          </div>
        </div>
      `).join('')}
    </div>
  `;
}

function displayRisks(analysis) {
  if (!analysis || !analysis.risk_flags) {
    return '<div class="data-section"><div style="color: #999;">‚è≥ Risk analysis pending...</div></div>';
  }
  if (!analysis.risk_flags?.length) {
    return '<div class="data-section"><div style="color: #999;">No significant risks</div></div>';
  }
  
  return `
    <div class="data-section">
      ${analysis.risk_flags.map(r => `
        <div class="data-row" style="flex-direction: column; align-items: flex-start;">
          <div style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 8px;">
            <span style="color: ${r.severity === 'high' ? '#f44336' : r.severity === 'medium' ? '#ffc107' : '#4caf50'}; font-weight: 600;">
              ${r.severity.toUpperCase()}
            </span>
          </div>
          <div style="color: #ccc;">${r.explanation}</div>
        </div>
      `).join('')}
    </div>
  `;
}

function displayRawData(company) {
  return `
    <div class="data-section">
      <pre style="background: #0a0a0a; padding: 20px; border-radius: 8px; overflow-x: auto; color: #4caf50; font-size: 12px;">${JSON.stringify(company, null, 2)}</pre>
    </div>
  `;
}

// Force Rescrape Function
async function forceRescrape(companyId, companyName) {
  if (!confirm(`Force rescrape "${companyName}"?\n\nThis will:\n- Re-gather data from the internet\n- Re-normalize with local Mistral\n- Update the stored company profile\n\nThis can take 30-120 seconds.`)) {
    return;
  }
  
  const container = document.getElementById('companyData');
  const render = (progress) => {
    const pct = Math.max(0, Math.min(100, progress?.progress_percentage ?? 0));
    const step = progress?.current_step || 'Starting...';
    const status = progress?.status || 'pending';
    const errors = (progress?.errors || []).slice(-2);
    container.innerHTML = `
      <div class="data-section">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom: 10px;">
          <div class="section-title">üîÑ Rescraping "${companyName}"</div>
          <div style="color:#ccc; font-size:13px;"><strong>${pct}%</strong> ‚Ä¢ ${status}</div>
        </div>
        <div style="color:#999; margin-bottom: 10px;">${step}</div>
        <div style="height: 8px; background: #333; border-radius: 4px; overflow:hidden;">
          <div style="height:100%; width:${pct}%; background:#ff9800;"></div>
        </div>
        <div style="margin-top: 10px; font-size: 12px; color: #777;">DB check ‚Üí Perplexity ‚Üí Verification ‚Üí Web scrape ‚Üí Mistral normalize ‚Üí Save</div>
        ${errors.length ? `<div style="margin-top: 10px; font-size: 12px; color: #ffc107;">‚ö†Ô∏è ${errors.map(e => String(e)).join(' ‚Ä¢ ')}</div>` : ''}
      </div>
    `;
  };

  render({ progress_percentage: 0, current_step: 'Starting request...', status: 'pending', errors: [] });
  
  try {
    // Get current company (for website hint if available)
    let website = null;
    try {
      const compRes = await fetch(`${API_BASE}/companies/${companyId}`);
      if (compRes.ok) {
        const company = await compRes.json();
        website = company?.online_presence?.website || null;
      }
    } catch (_) {
      // ignore
    }

    const gatherPromise = fetch(`${API_BASE}/scraping/gather?skip_ai_search=true`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ company_name: companyName, website, force_rescrape: true })
    });

    let pollTimer = setInterval(async () => {
      try {
        const pRes = await fetch(`${API_BASE}/scraping/progress/${encodeURIComponent(companyName)}`);
        if (!pRes.ok) return;
        const progress = await pRes.json();
        render(progress);
      } catch (_) {
        // ignore
      }
    }, 1000);

    const res = await gatherPromise;
    clearInterval(pollTimer);

    if (!res.ok) {
      let detail = `HTTP ${res.status}`;
      try {
        const body = await res.json();
        detail = body?.detail || JSON.stringify(body);
      } catch (_) {}
      throw new Error(detail);
    }

    const result = await res.json();
    const nextId = result?.company_id || companyId;
    loadCompany(nextId);
    
  } catch (err) {
    console.error('Rescrape error:', err);
    container.innerHTML = `
      <div class="data-section">
        <div class="error">
          ‚ùå Rescrape failed: ${err.message}<br>
          <small>Check backend logs for details</small>
        </div>
      </div>
    `;
  }
}

// Companies Table
async function loadCompaniesTable() {
  try {
    const res = await fetch(`${API_BASE}/companies?limit=500`);
    const companies = await res.json();

    // Batch-check whether each company already has cached analysis
    analysisReadyByCompanyId = {};
    try {
      const ids = companies.map(c => c._id).filter(Boolean);
      const statusRes = await fetch(`${API_BASE}/analysis/status`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ company_ids: ids })
      });
      if (statusRes.ok) {
        const status = await statusRes.json();
        analysisReadyByCompanyId = status?.ready || {};
      }
    } catch (e) {
      // ignore status errors; table still renders
    }
    
    displayCompaniesTable(companies);
    
    // Setup filter
    document.getElementById('companyTableSearch').addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      const filtered = companies.filter(c => 
        c.company_name.toLowerCase().includes(query) ||
        c.industries?.some(i => i.toLowerCase().includes(query)) ||
        c.geography?.hq?.country?.toLowerCase().includes(query)
      );
      displayCompaniesTable(filtered);
    });
  } catch (err) {
    console.error('Companies table error:', err);
    document.getElementById('companiesTable').innerHTML = '<div class="error">Failed to load companies</div>';
  }
}

function displayCompaniesTable(companies) {
  const html = `
    <div style="overflow-x: auto;">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #1a1a1a; border-bottom: 2px solid #333;">
            <th style="padding: 12px; text-align: left; font-weight: 600;">Company</th>
            <th style="padding: 12px; text-align: left; font-weight: 600;">Analysis</th>
            <th style="padding: 12px; text-align: left; font-weight: 600;">Industries</th>
            <th style="padding: 12px; text-align: left; font-weight: 600;">Location</th>
            <th style="padding: 12px; text-align: left; font-weight: 600;">Employees</th>
            <th style="padding: 12px; text-align: left; font-weight: 600;">Added</th>
          </tr>
        </thead>
        <tbody>
          ${companies.map(c => `
            <tr style="border-bottom: 1px solid #2a2a2a; cursor: pointer; transition: background 0.2s;" onclick="loadCompany('${c._id}')" onmouseover="this.style.background='#1a1a1a'" onmouseout="this.style.background='transparent'">
              <td style="padding: 12px; font-weight: 600;">${c.company_name}</td>
              <td style="padding: 12px; font-size: 12px;">
                ${analysisReadyByCompanyId?.[c._id]
                  ? '<span style="display:inline-block; padding: 4px 8px; border-radius: 999px; border: 1px solid #4caf50; color:#4caf50; background: rgba(76,175,80,0.08);">Ready</span>'
                  : '<span style="display:inline-block; padding: 4px 8px; border-radius: 999px; border: 1px solid #ffc107; color:#ffc107; background: rgba(255,193,7,0.08);">Pending</span>'}
              </td>
              <td style="padding: 12px; color: #999; font-size: 13px;">${c.industries?.slice(0, 2).join(', ') || 'N/A'}</td>
              <td style="padding: 12px; color: #999; font-size: 13px;">${getFlag(c.geography?.hq?.country)} ${c.geography?.hq?.country || 'Unknown'}</td>
              <td style="padding: 12px; color: #999; font-size: 13px;">${c.company_size?.employee_count?.toLocaleString() || 'N/A'}</td>
              <td style="padding: 12px; color: #666; font-size: 12px;">${new Date(c.created_at).toLocaleDateString()}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
  document.getElementById('companiesTable').innerHTML = html;
}

function switchTab(index) {
  const tabs = document.querySelectorAll('.tab');
  const contents = document.querySelectorAll('.tab-content');
  
  tabs.forEach((t, i) => {
    t.classList.toggle('active', i === index);
  });
  
  contents.forEach((c, i) => {
    c.classList.toggle('active', i === index);
  });
}

function showDashboard() {
  document.getElementById('companyView').classList.remove('active');
  document.getElementById('dashboardView').style.display = 'block';
  loadDashboard();
}

function filterCompanies(label) {
  console.log('Filter by:', label);
}
</script>

</body>
</html>
